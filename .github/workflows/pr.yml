---
name: .dotfiles PR
# yamllint disable-line rule:truthy
on:
  workflow_dispatch:
  pull_request:

jobs:
  check:
    name: pre-commit
    runs-on: ubuntu-latest
    env:
      DOTFILES_CI: 'true'
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"
      - uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-5|${{ hashFiles('uv.lock') }}|${{ hashFiles('.pre-commit-config.yaml') }}
      - run: uv run alias check

  run-setup:
    needs: check
    name: ${{ matrix.task.name }} on ${{ matrix.os.name }}
    runs-on: ${{ matrix.os.runner }}
    strategy:
      matrix:
        os:
          - name: fedora:latest
            runner: ubuntu-latest
            image: jrei/systemd-fedora:latest
          - name: fedora:42
            runner: ubuntu-latest
            image: jrei/systemd-fedora:42
          - name: debian:sid
            runner: ubuntu-latest
            image: jrei/systemd-debian:sid
          - name: debian:trixie
            runner: ubuntu-latest
            image: jrei/systemd-debian:13
          - name: ubuntu:latest
            runner: ubuntu-latest
            image: jrei/systemd-ubuntu:latest
          - name: ubuntu:LTS
            runner: ubuntu-latest
            image: jrei/systemd-ubuntu:24.04
          - name: macos:latest
            runner: macos-latest
            options: ''
        task:
          - name: workstation
            enable_sudo: 'true'
          - name: server
            enable_sudo: 'true'
          - name: justuser
            enable_sudo: 'false'
    container:
      image: ${{ matrix.os.image || '' }}
      options: ${{ matrix.os.options || '--privileged -v /sys/fs/cgroup:/sys/fs/cgroup:ro' }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Setup and run dotfiles
        uses: ./.github/actions/setup-and-run-dotfiles
        with:
          pkgs: 'git curl sudo'
          setup_args: ${{ matrix.task.setup_args }}
          task_name: ${{ matrix.task.name }}
          enable_sudo: ${{ matrix.task.enable_sudo }}

  test:
    if: ${{ always() }}
    runs-on: ubuntu-latest
    needs: [run-setup]
    steps:
      - run: exit 1
        if: ${{ contains(toJSON(needs.*.result), 'failure') || contains(toJSON(needs.*.result), 'cancelled') }}
