---
name: .dotfiles PR
# yamllint disable-line rule:truthy
on:
  workflow_dispatch:
  pull_request:

jobs:
  check:
    name: pre-commit
    runs-on: ubuntu-latest
    env:
      DOTFILES_CI: 'true'
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
      - uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244 # v7.1.4
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"
      - uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-5|${{ hashFiles('uv.lock') }}|${{ hashFiles('.pre-commit-config.yaml') }}
      - run: uv run alias check

  run-setup:
    needs: check
    name: ${{ matrix.task.name }} on ${{ matrix.os.name }}
    runs-on: ${{ matrix.os.runner }}
    strategy:
      matrix:
        os:
          - name: fedora:latest
            runner: ubuntu-latest
            image: jrei/systemd-fedora:latest
          - name: fedora:42
            runner: ubuntu-latest
            image: jrei/systemd-fedora:42
          - name: fedora:42-cosmic
            runner: ubuntu-latest
            image: tkk2112/fedora-42-cosmic-spin:latest
            options: '--privileged --tmpfs /run -v /sys/fs/cgroup:/sys/fs/cgroup:ro'
          - name: debian:sid
            runner: ubuntu-latest
            image: jrei/systemd-debian:sid
          - name: debian:trixie
            runner: ubuntu-latest
            image: jrei/systemd-debian:13
          - name: ubuntu:latest
            runner: ubuntu-latest
            image: jrei/systemd-ubuntu:latest
          - name: ubuntu:LTS
            runner: ubuntu-latest
            image: jrei/systemd-ubuntu:24.04
          - name: macos:latest
            runner: macos-latest
        task:
          - name: workstation
          - name: server
          - name: justuser
    # yamllint disable-line rule:line-length
    container: ${{ matrix.os.image && format('{{"image":"{0}","options":"{1}"}}', matrix.os.image, matrix.os.options || '--privileged -v /sys/fs/cgroup:/sys/fs/cgroup:ro') || null }}
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
      - name: Setup and run dotfiles
        uses: ./.github/actions/setup-and-run-dotfiles
        with:
          pkgs: 'git curl sudo'
          setup_args: ${{ matrix.task.setup_args }}
          task_name: ${{ matrix.task.name }}
          username: 'testuser'
          uid: '1000'
          gid: '1000'
          enable_sudo: 'true'

  test:
    if: ${{ always() }}
    runs-on: ubuntu-latest
    needs: [run-setup]
    steps:
      - run: exit 1
        if: ${{ contains(toJSON(needs.*.result), 'failure') || contains(toJSON(needs.*.result), 'cancelled') }}
