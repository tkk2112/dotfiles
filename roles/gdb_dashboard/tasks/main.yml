- name: Ensure the GDB init directory exists
  ansible.builtin.file:
    path: "{{ gdb_dashboard_init_dir }}"
    state: directory
    mode: '0755'

- name: Symlink dashboard configuration file to GDB init directory
  ansible.builtin.file:
    src: "{{ role_path }}/files/gdbinit.d/init"
    dest: "{{ gdb_dashboard_init_dir }}/init"
    state: link
    force: true

- name: Clone the gdb-dashboard repository
  ansible.builtin.git:
    repo: "{{ gdb_dashboard_repo }}"
    dest: "{{ gdb_dashboard_dest }}"
    version: "master"
    update: true

- name: Get list of files in GDB init directory
  ansible.builtin.find:
    paths: "{{ gdb_dashboard_init_dir }}"
    file_type: file
  register: init_files

- name: Add source lines to the main GDB init file
  ansible.builtin.copy:
    dest: "{{ gdb_dashboard_init_file }}"
    content: |
      source {{ gdb_dashboard_dest }}/.gdbinit
      source {{ gdb_dashboard_init_dir }}/init
      {%- for file in init_files.files %}
      {%- if file.path != gdb_dashboard_init_dir + '/init' %}
      source {{ file.path }}
      {%- endif %}
      {%- endfor %}
    mode: '0644'
