---
- name: Configure local system
  hosts: localhost
  connection: local
  gather_facts: true

  vars:
    dotfiles_dir: "{{ dotfiles_dir | default(ansible_env.HOME + '/.dotfiles') }}"

  pre_tasks:
    - name: Load host-specific variables when present
      vars:
        candidate_host: "{{ ansible_facts.hostname | default(inventory_hostname) }}"
      block:
        - name: Check host vars file
          ansible.builtin.stat:
            path: "{{ playbook_dir }}/../host_vars/{{ candidate_host }}.yml"
          register: host_vars_file

        - name: Include host vars
          ansible.builtin.include_vars: "{{ playbook_dir }}/../host_vars/{{ candidate_host }}.yml"
          when: host_vars_file.stat.exists

    - name: Initialize flags and accumulators
      ansible.builtin.set_fact:
        headless: false
        personal: false
        internal: false
        profile_roles_extra: []
        disable_roles: []
        host_disable_roles_list: []

    - name: Detect passwordless sudo (best-effort)
      ansible.builtin.command: sudo -n true
      register: local_pwless_sudo_check
      changed_when: false
      failed_when: false
      check_mode: false
      when: ansible_facts.user_id != 'root'

    - name: Set root capability fact
      ansible.builtin.set_fact:
        pwless_sudo: >-
          {{
            true
            if ansible_facts.user_id == 'root'
            else (local_pwless_sudo_check.rc | default(1) == 0)
          }}

    - name: Set allow_root default based on sudo capability
      ansible.builtin.set_fact:
        allow_root: >-
          {{
            allow_root
            if (allow_root is defined)
            else (
              true
              if ansible_facts.user_id == 'root'
              else (pwless_sudo | default(false) | bool)
            )
          }}

    - name: Determine detected profiles
      ansible.builtin.set_fact:
        detected_profiles: "{{ ['nosudo'] if (not pwless_sudo | default(false) | bool) else [] }}"

    - name: Determine OS key
      ansible.builtin.set_fact:
        selected_os: >-
          {{
            os_family | default(
              'debian' if ansible_facts.distribution in ['Debian', 'Ubuntu']
              else 'fedora' if ansible_facts.distribution == 'Fedora'
              else 'macos' if ansible_facts.distribution == 'MacOSX'
              else 'unknown'
            )
          }}

    - name: Ensure OS variables exist
      when: selected_os == 'unknown'
      ansible.builtin.fail:
        msg: "Unsupported distribution {{ ansible_facts.distribution }} (set os_family to override)."

    - name: Load OS variables
      when: selected_os != 'unknown'
      block:
        - name: Check OS vars file
          ansible.builtin.stat:
            path: "{{ playbook_dir }}/../group_vars/os/{{ selected_os }}.yml"
          register: os_vars_file

        - name: Fail if OS vars file missing
          ansible.builtin.fail:
            msg: "Missing OS vars file {{ playbook_dir }}/../group_vars/os/{{ selected_os }}.yml"
          when: not os_vars_file.stat.exists

        - name: Include OS vars
          ansible.builtin.include_vars: "{{ playbook_dir }}/../group_vars/os/{{ selected_os }}.yml"

    - name: Determine active profiles
      ansible.builtin.set_fact:
        profiles_effective: >-
          {{
            (
              (detected_profiles | default([]))
              + (
                profiles
                if (profiles is defined)
                else (['personal'] if machine_type | default('') == 'workstation' else ['server'])
              )
            ) | unique
          }}

    - name: Apply nosudo profile to root usage
      ansible.builtin.set_fact:
        allow_root: "{{ (allow_root | default(false) | bool) and ('nosudo' not in profiles_effective) }}"

    - name: Include profile vars
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../group_vars/profile/{{ item }}.yml"
        name: profile_item
      loop: "{{ profiles_effective }}"
      register: profile_vars_loaded

    - name: Merge profile vars into facts
      ansible.builtin.set_fact:
        headless: "{{ headless | bool or (item.ansible_facts.profile_item.headless | default(false) | bool) }}"
        personal: "{{ personal | bool or (item.ansible_facts.profile_item.personal | default(false) | bool) }}"
        internal: "{{ internal | bool or (item.ansible_facts.profile_item.internal | default(false) | bool) }}"
        profile_roles_extra: "{{ (profile_roles_extra + (item.ansible_facts.profile_item.profile_roles_extra | default([]))) | unique }}"
        disable_roles: >-
          {{
            (
              disable_roles
              + (item.ansible_facts.profile_item.disable_roles | default([]))
              + (item.ansible_facts.profile_item.disallow_root_roles | default([]))
            ) | unique
          }}
      loop: "{{ profile_vars_loaded.results }}"

    - name: Default host disable roles list
      ansible.builtin.set_fact:
        host_disable_roles_list: []

    - name: Build host disable roles list
      ansible.builtin.set_fact:
        host_disable_roles_list: "{{ disable_roles_host | default([]) }}"
      when: disable_roles_host is defined and disable_roles_host is not mapping

    - name: Build host disable roles list from mapping
      ansible.builtin.set_fact:
        host_disable_roles_list: >-
          {{
            disable_roles_host | default({}) | dict2items
            | selectattr('value', 'equalto', true)
            | map(attribute='key') | list
          }}
      when: disable_roles_host is defined and disable_roles_host is mapping

    - name: Merge host disable roles into final disable list
      ansible.builtin.set_fact:
        disable_roles: "{{ (disable_roles + host_disable_roles_list) | unique }}"

    - name: Default install roles list
      ansible.builtin.set_fact:
        install_roles_list: []

    - name: Build install roles list
      ansible.builtin.set_fact:
        install_roles_list: "{{ install_roles | default([]) }}"
      when: install_roles is defined and install_roles is not mapping

    - name: Build install roles list from mapping
      ansible.builtin.set_fact:
        install_roles_list: >-
          {{
            install_roles | default({}) | dict2items
            | selectattr('value', 'equalto', true)
            | map(attribute='key') | list
          }}
      when: install_roles is defined and install_roles is mapping

    - name: Build final role list
      ansible.builtin.set_fact:
        profile_roles_final: >-
          {{
            (
              (profile_roles | default([]))
              + (profile_roles_extra | default([]))
              + (install_roles_list | default([]))
            ) | unique
          }}

    - name: Decide allowed roles (root vs non-root)
      ansible.builtin.set_fact:
        roles_to_run: >-
          {{
            profile_roles_final
            | difference(disable_roles | default([]))
          }}

    - name: Debug - Print configuration overview
      ansible.builtin.debug:
        msg:
          - "╔════════════════════════════════════════════════════════════════════════════╗"
          - "║                    DOTFILES CONFIGURATION DEBUG OUTPUT                     ║"
          - "╠════════════════════════════════════════════════════════════════════════════╣"
          - "║ Hostname: {{ ansible_facts.hostname | default(inventory_hostname) }}"
          - "║ Distribution: {{ ansible_facts.distribution }} ({{ selected_os }})"
          - "║ User: {{ ansible_facts.user_id }}"
          - "║ Machine Type: {{ machine_type | default('not set') }}"
          - "║ Profiles: {{ profiles_effective | join(', ') }}"
          - "║ Detected Profiles: {{ detected_profiles | default([]) | join(', ') }}"
          - "║ OS Vars: group_vars/os/{{ selected_os }}.yml"
          - "║ Profile Vars: group_vars/profile/<profile>.yml"
          - "╠════════════════════════════════════════════════════════════════════════════╣"
          - "║ FLAGS:"
          - "║   Headless: {{ headless | default(false) }}"
          - "║   Personal: {{ personal | default(false) }}"
          - "║   Internal: {{ internal | default(false) }}"
          - "║   Allow Root: {{ allow_root | default(true) }}"
          - "║   Passwordless Sudo: {{ pwless_sudo | default(false) }}"
          - "╠════════════════════════════════════════════════════════════════════════════╣"
          - "║ OS DEFAULT ROLES (from group_vars/os/{{ selected_os }}.yml):"
          - "║   {{ profile_roles | default([]) | join(', ') }}"
          - "╠════════════════════════════════════════════════════════════════════════════╣"
          - "║ PROFILE EXTRA ROLES (from group_vars/profile/<profile>.yml):"
          - "║   {{ profile_roles_extra | default([]) | join(', ') }}"
          - "╠════════════════════════════════════════════════════════════════════════════╣"
          - "║ INSTALL ROLES (from host_vars/{{ ansible_facts.hostname | default(inventory_hostname) }}.yml):"
          - >-
            ║   {{
              (
                (install_roles | default({}) | dict2items | selectattr('value') | map(attribute='key') | list | join(', '))
                if (install_roles is defined and install_roles is mapping)
                else (install_roles | default([]) | join(', '))
              )
            }}
          - "╠════════════════════════════════════════════════════════════════════════════╣"
          - "║ INSTALL ROLES LIST (processed):"
          - "║   {{ install_roles_list | default([]) | join(', ') }}"
          - "╠════════════════════════════════════════════════════════════════════════════╣"
          - "║ PROFILE ROLES FINAL (merged):"
          - "║   {{ profile_roles_final | default([]) | join(', ') }}"
          - "╠════════════════════════════════════════════════════════════════════════════╣"
          - "║ DISABLED ROLES (host/profile/detection):"
          - "║   {{ disable_roles | default([]) | join(', ') if disable_roles | default([]) | length > 0 else '(none)' }}"
          - "╠════════════════════════════════════════════════════════════════════════════╣"
          - "║ ROLES TO RUN (final list after filtering):"
          - "║   {{ roles_to_run | default([]) | join(', ') }}"
          - "╚════════════════════════════════════════════════════════════════════════════╝"
      when: lookup('env', 'DOTFILES_DEBUG') | length > 0
      tags: skip_ansible_lint

  roles:
    - role: base
      when: "'base' in roles_to_run"
    - role: zsh
      when: "'zsh' in roles_to_run"
    - role: git
      when: "'git' in roles_to_run"
    - role: tmux
      when: "'tmux' in roles_to_run"
    - role: go
      when: "'go' in roles_to_run"
    - role: gaming
      when: "'gaming' in roles_to_run"
